# 第一次迭代API测试计划 v3.0

## 测试环境

- 基础URL: http://localhost:8080/api
- 测试工具: Postman
- 测试数据库: H2/MySQL

## 测试流程

### 1. 准备工作

1. 创建Postman Collection: `校企合作平台API测试`
2. 添加环境变量:
   - `base_url`: http://localhost:8080/api
   - `jwt_token`: (空，在登录成功后自动填充)
   - `student_email`: (空，在注册学生后自动填充)
   - `student_account`: (空，在注册学生后自动填充)

### 2. 测试系统管理员登录（通过账号登录）

**请求**:
- 方法: POST
- URL: {{base_url}}/v1/auth/login
- Headers: Content-Type: application/json
- Body: 
```json
{
  "loginType": "account",
  "principal": "admin1",
  "password": "admin123"
}
```

**预期结果**:
- 状态码: 200 OK
- 响应包含token
- 设置测试脚本自动提取token并保存到环境变量:
```javascript
var jsonData = pm.response.json();
if (jsonData && jsonData.token) {
    pm.environment.set("jwt_token", jsonData.token);
}
```

### 3. 测试创建学校

**前提条件**: 已成功执行管理员登录并设置了jwt_token

**请求**:
- 方法: POST
- URL: {{base_url}}/v1/admin/organizations/schools
- Headers: 
  - Content-Type: application/json
  - Authorization: Bearer {{jwt_token}}
- Body: 
```json
{
  "organizationName": "测试大学",
  "description": "这是一所测试用的大学",
  "address": "测试市测试区测试路123号",
  "website": "http://www.testuniversity.edu",
  "adminNickname": "校管理员",
  "adminPassword": "admin123",
  "adminEmail": "school_admin@test.edu"
}
```

**预期结果**:
- 状态码: 201 Created
- 响应包含学校信息和系统自动生成的管理员账号（格式为"admin_xxx"）
- 设置测试脚本自动提取学校ID和管理员账号:
```javascript
var jsonData = pm.response.json();
if (jsonData && jsonData.data) {
    pm.environment.set("school_id", jsonData.data.id);
    // 提取管理员账号可能需要额外API调用，此处暂不设置
}
```

### 4. 测试查询学校列表

**请求**:
- 方法: GET
- URL: {{base_url}}/v1/organizations/schools
- Headers: Content-Type: application/json

**预期结果**:
- 状态码: 200 OK
- 响应包含学校列表
- 列表中包含刚才创建的学校

### 5. 测试学生注册

**请求**:
- 方法: POST
- URL: {{base_url}}/v1/auth/register/student
- Headers: Content-Type: application/json
- Body: 
```json
{
  "nickname": "测试学生",
  "password": "password123",
  "email": "student1@test.edu",
  "phone": "13800138000",
  "organizationId": 1,
  "realName": "张三",
  "idCard": "110101200001010011"
}
```

**预期结果**:
- 状态码: 201 Created
- 响应包含学生用户信息，包括系统生成的账号
- 设置测试脚本自动提取邮箱和账号并保存到环境变量:
```javascript
var jsonData = pm.response.json();
if (jsonData) {
    pm.environment.set("student_email", jsonData.email);
    pm.environment.set("student_account", jsonData.account);
}
```

### 6. 测试通过邮箱登录

**请求**:
- 方法: POST
- URL: {{base_url}}/v1/auth/login
- Headers: Content-Type: application/json
- Body: 
```json
{
  "loginType": "email",
  "principal": "{{student_email}}",
  "password": "password123"
}
```

**预期结果**:
- 状态码: 200 OK
- 响应包含token
- 设置测试脚本自动提取token并保存到环境变量:
```javascript
var jsonData = pm.response.json();
if (jsonData && jsonData.token) {
    pm.environment.set("jwt_token", jsonData.token);
}
```

### 7. 测试通过账号登录

**请求**:
- 方法: POST
- URL: {{base_url}}/v1/auth/login
- Headers: Content-Type: application/json
- Body: 
```json
{
  "loginType": "account",
  "principal": "{{student_account}}",
  "password": "password123"
}
```

**预期结果**:
- 状态码: 200 OK
- 响应包含token

### 8. 测试通过手机号登录

**请求**:
- 方法: POST
- URL: {{base_url}}/v1/auth/login
- Headers: Content-Type: application/json
- Body: 
```json
{
  "loginType": "phone",
  "principal": "13800138000",
  "password": "password123"
}
```

**预期结果**:
- 状态码: 200 OK
- 响应包含token

### 9. 测试获取当前用户信息

**前提条件**: 已成功执行登录并设置了jwt_token

**请求**:
- 方法: GET
- URL: {{base_url}}/v1/auth/me
- Headers: 
  - Content-Type: application/json
  - Authorization: Bearer {{jwt_token}}

**预期结果**:
- 状态码: 200 OK
- 响应包含当前登录用户的信息
- 用户信息中的account应是系统生成的账号格式（如"tdu25xxxxx"）

## 测试失败场景

### 1. 测试注册时使用已存在的邮箱

**请求**:
- 方法: POST
- URL: {{base_url}}/v1/auth/register/student
- Headers: Content-Type: application/json
- Body: 
```json
{
  "nickname": "重复邮箱测试",
  "password": "password123",
  "email": "{{student_email}}",
  "organizationId": 1,
  "realName": "李四",
  "idCard": "110101200001010022"
}
```

**预期结果**:
- 状态码: 400 Bad Request
- 响应包含"该邮箱已被注册"的错误消息

### 2. 测试注册时使用已存在的手机号

**请求**:
- 方法: POST
- URL: {{base_url}}/v1/auth/register/student
- Headers: Content-Type: application/json
- Body: 
```json
{
  "nickname": "重复手机号测试",
  "password": "password123",
  "email": "another_student@test.edu",
  "phone": "13800138000",
  "organizationId": 1,
  "realName": "王五",
  "idCard": "110101200001010033"
}
```

**预期结果**:
- 状态码: 400 Bad Request
- 响应包含"该手机号已被注册"的错误消息

### 3. 测试登录时使用不存在的账号

**请求**:
- 方法: POST
- URL: {{base_url}}/v1/auth/login
- Headers: Content-Type: application/json
- Body: 
```json
{
  "loginType": "account",
  "principal": "nonexistent_account",
  "password": "password123"
}
```

**预期结果**:
- 状态码: 401 Unauthorized
- 响应包含"用户不存在"的错误消息

## 测试注意事项

1. 确保测试顺序正确，先创建数据再进行其他操作
2. 验证系统生成的账号格式是否符合预期（学校简称 + 年份后两位 + 5位递增序号）
3. 测试所有三种登录方式：账号、邮箱和手机号
4. 记得检查返回的错误码和错误消息是否符合预期
5. 在每个请求后验证响应状态码和响应体的格式与内容

