# 第三次迭代测试计划：个人资料管理

## 1. 测试概述

### 1.1 测试目标
验证第三次迭代中开发的个人资料管理功能是否正常工作，包括：
1. 获取用户个人资料接口功能正确性
2. 更新用户个人资料接口功能正确性
3. 安全机制是否有效，防止未授权访问和水平越权
4. 数据验证机制是否正常工作
5. 错误处理是否符合预期

### 1.2 测试范围
- 单元测试：`UserServiceImpl`的新增方法
- 集成测试：API接口端到端测试
- 安全测试：JWT授权和防越权测试

### 1.3 测试环境
- 开发环境：JDK 17，Spring Boot 3.4.7，MySQL 8.0
- 测试工具：JUnit 5，Mockito，Postman

## 2. 单元测试计划

### 2.1 UserServiceImpl 测试

#### 2.1.1 getUserProfile方法测试
| 测试点 | 预期结果 | 测试数据 |
| ------ | ------ | ------ |
| 正常获取用户资料 | 返回正确的UserProfileVO对象 | 存在的用户名 |
| 用户不存在 | 抛出"用户不存在"异常 | 不存在的用户名 |
| 手机号脱敏 | 返回的手机号被正确脱敏（138****8888） | 11位手机号 |

#### 2.1.2 updateUserProfile方法测试
| 测试点 | 预期结果 | 测试数据 |
| ------ | ------ | ------ |
| 成功更新昵称和头像 | 用户信息被更新 | 有效的昵称和头像URL |
| 更新手机号成功 | 用户手机号被更新 | 有效的新手机号 |
| 手机号已被使用 | 抛出"该手机号已被其他用户使用"异常 | 已被其他用户使用的手机号 |
| 用户不存在 | 抛出"用户不存在"异常 | 不存在的用户名 |
| 无效的输入数据 | 验证失败，抛出异常 | 超长昵称或无效格式手机号 |

## 3. API测试计划（Postman）

### 3.1 环境设置

#### 3.1.1 创建环境变量
1. 打开Postman，点击右上角的"Environments"，然后点击"Create environment"
2. 环境名称命名为"Linknei-Dev"
3. 添加以下环境变量：
   - `baseUrl`: http://localhost:8081/api
   - `token`: (初始为空，后续登录后填入)

#### 3.1.2 导入API集合
1. 下载Postman集合JSON文件（如有提供）或者手动创建新集合
2. 在Postman中点击"Import"，导入集合文件或创建"Linknei API"集合

### 3.2 前置准备：用户注册和登录

#### 3.2.1 用户注册请求
1. 创建POST请求：`{{baseUrl}}/user/register`
2. 请求体(JSON格式)：
```json
{
  "username": "testuser",
  "password": "password123",
  "phone": "13800138000"
}
```
3. 发送请求，确认返回成功状态码(200)

#### 3.2.2 用户登录请求
1. 创建POST请求：`{{baseUrl}}/user/login`
2. 请求体(JSON格式)：
```json
{
  "username": "testuser",
  "password": "password123"
}
```
3. 发送请求，保存返回的token：
   - 在"Tests"标签中添加脚本：
```javascript
const jsonData = pm.response.json();
if (jsonData && jsonData.code === 200 && jsonData.data && jsonData.data.token) {
    pm.environment.set("token", jsonData.data.token);
}
```

### 3.3 测试获取用户个人资料API

#### 3.3.1 基本功能测试
1. 创建GET请求：`{{baseUrl}}/user/profile`
2. 在"Authorization"标签中选择"Bearer Token"，并输入`{{token}}`
3. 发送请求，验证返回状态码为200，且返回数据包含用户信息字段

#### 3.3.2 无授权测试
1. 移除Authorization头或使用无效token
2. 发送请求，验证返回401未授权错误

### 3.4 测试更新用户个人资料API

#### 3.4.1 昵称更新测试
1. 创建PUT请求：`{{baseUrl}}/user/profile`
2. 在"Authorization"标签中选择"Bearer Token"，并输入`{{token}}`
3. 请求体(JSON格式)：
```json
{
  "nickname": "新昵称"
}
```
4. 发送请求，验证返回成功状态码(200)
5. 执行获取资料请求，验证昵称已更新

#### 3.4.2 头像更新测试
1. 使用相同的PUT请求
2. 请求体(JSON格式)：
```json
{
  "avatarUrl": "https://example.com/new_avatar.jpg"
}
```
3. 发送请求，验证返回成功状态码(200)
4. 执行获取资料请求，验证头像已更新

#### 3.4.3 手机号更新测试
1. 使用相同的PUT请求
2. 请求体(JSON格式)：
```json
{
  "phone": "13900000000"
}
```
3. 发送请求，验证返回成功状态码(200)
4. 执行获取资料请求，验证手机号已更新(注意查看脱敏显示)

#### 3.4.4 无效数据测试
1. 提供无效格式的手机号：
```json
{
  "phone": "123456"
}
```
2. 发送请求，验证返回400错误

#### 3.4.5 无授权测试
1. 移除Authorization头或使用无效token
2. 发送请求，验证返回401未授权错误

## 4. 测试数据管理

### 4.1 测试数据准备
| 用户名 | 密码 | 手机号 | 用途 |
| ------ | ------ | ------ | ------ |
| testuser1 | password123 | 13800138001 | 主要测试账号 |
| testuser2 | password123 | 13800138002 | 辅助测试账号（用于验证手机号唯一性） |

### 4.2 测试数据清理
1. 测试完成后，可以通过软删除或直接从数据库移除测试用户
2. SQL清理脚本：
```sql
-- 软删除（推荐）
UPDATE `user` SET is_deleted = 1 WHERE username LIKE 'testuser%';

-- 硬删除（谨慎使用）
-- DELETE FROM `user` WHERE username LIKE 'testuser%';
```

## 5. 自动化测试脚本（Postman）

### 5.1 创建测试集合
在Postman中创建一个集合，包括以下请求：
1. 用户注册
2. 用户登录
3. 获取个人资料
4. 更新昵称
5. 更新头像
6. 更新手机号
7. 提交无效数据

### 5.2 自动化测试脚本
为每个请求添加测试脚本，示例如下：

#### 登录请求测试脚本：
```javascript
const jsonData = pm.response.json();
pm.test("状态码为200", () => {
    pm.response.to.have.status(200);
});
pm.test("返回有效token", () => {
    pm.expect(jsonData.data).to.have.property('token');
    pm.environment.set("token", jsonData.data.token);
});
```

#### 获取个人资料测试脚本：
```javascript
const jsonData = pm.response.json();
pm.test("状态码为200", () => {
    pm.response.to.have.status(200);
});
pm.test("返回用户名正确", () => {
    pm.expect(jsonData.data.username).to.eql("testuser1");
});
pm.test("手机号已脱敏", () => {
    pm.expect(jsonData.data.phone).to.match(/^\d{3}\*{4}\d{4}$/);
});
```

#### 更新资料测试脚本：
```javascript
const jsonData = pm.response.json();
pm.test("状态码为200", () => {
    pm.response.to.have.status(200);
});
pm.test("返回成功消息", () => {
    pm.expect(jsonData.message).to.include("成功");
});
```

### 5.3 Postman集合导出示例
以下是一个可以直接导入Postman的集合示例（可以复制到文件中保存为JSON格式，然后导入）：

```json
{
  "info": {
    "name": "Linknei API - 个人资料管理测试",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "用户注册",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"username\": \"testuser1\",\n  \"password\": \"password123\",\n  \"phone\": \"13800138001\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/user/register",
          "host": ["{{baseUrl}}"],
          "path": ["user", "register"]
        },
        "description": "注册测试用户账号"
      },
      "response": []
    },
    {
      "name": "用户登录",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "const jsonData = pm.response.json();",
              "pm.test(\"状态码为200\", () => {",
              "    pm.response.to.have.status(200);",
              "});",
              "pm.test(\"返回有效token\", () => {",
              "    pm.expect(jsonData.data).to.have.property('token');",
              "    pm.environment.set(\"token\", jsonData.data.token);",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"username\": \"testuser1\",\n  \"password\": \"password123\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/user/login",
          "host": ["{{baseUrl}}"],
          "path": ["user", "login"]
        },
        "description": "登录并获取JWT token"
      },
      "response": []
    },
    {
      "name": "获取个人资料",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "const jsonData = pm.response.json();",
              "pm.test(\"状态码为200\", () => {",
              "    pm.response.to.have.status(200);",
              "});",
              "pm.test(\"返回用户名正确\", () => {",
              "    pm.expect(jsonData.data.username).to.eql(\"testuser1\");",
              "});",
              "pm.test(\"手机号已脱敏\", () => {",
              "    pm.expect(jsonData.data.phone).to.match(/^\\d{3}\\*{4}\\d{4}$/);",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "auth": {
          "type": "bearer",
          "bearer": [
            {
              "key": "token",
              "value": "{{token}}",
              "type": "string"
            }
          ]
        },
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/user/profile",
          "host": ["{{baseUrl}}"],
          "path": ["user", "profile"]
        },
        "description": "获取当前登录用户的个人资料"
      },
      "response": []
    },
    {
      "name": "更新昵称",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "const jsonData = pm.response.json();",
              "pm.test(\"状态码为200\", () => {",
              "    pm.response.to.have.status(200);",
              "});",
              "pm.test(\"返回成功消息\", () => {",
              "    pm.expect(jsonData.message).to.include(\"成功\");",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "auth": {
          "type": "bearer",
          "bearer": [
            {
              "key": "token",
              "value": "{{token}}",
              "type": "string"
            }
          ]
        },
        "method": "PUT",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"nickname\": \"测试用户更新后的昵称\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/user/profile",
          "host": ["{{baseUrl}}"],
          "path": ["user", "profile"]
        },
        "description": "更新用户昵称"
      },
      "response": []
    },
    {
      "name": "更新头像",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "const jsonData = pm.response.json();",
              "pm.test(\"状态码为200\", () => {",
              "    pm.response.to.have.status(200);",
              "});",
              "pm.test(\"返回成功消息\", () => {",
              "    pm.expect(jsonData.message).to.include(\"成功\");",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "auth": {
          "type": "bearer",
          "bearer": [
            {
              "key": "token",
              "value": "{{token}}",
              "type": "string"
            }
          ]
        },
        "method": "PUT",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"avatarUrl\": \"https://example.com/new_avatar.jpg\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/user/profile",
          "host": ["{{baseUrl}}"],
          "path": ["user", "profile"]
        },
        "description": "更新用户头像"
      },
      "response": []
    },
    {
      "name": "更新手机号",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "const jsonData = pm.response.json();",
              "pm.test(\"状态码为200\", () => {",
              "    pm.response.to.have.status(200);",
              "});",
              "pm.test(\"返回成功消息\", () => {",
              "    pm.expect(jsonData.message).to.include(\"成功\");",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "auth": {
          "type": "bearer",
          "bearer": [
            {
              "key": "token",
              "value": "{{token}}",
              "type": "string"
            }
          ]
        },
        "method": "PUT",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"phone\": \"13900000001\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/user/profile",
          "host": ["{{baseUrl}}"],
          "path": ["user", "profile"]
        },
        "description": "更新用户手机号"
      },
      "response": []
    },
    {
      "name": "无效手机号测试",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"状态码为400\", () => {",
              "    pm.response.to.have.status(400);",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "auth": {
          "type": "bearer",
          "bearer": [
            {
              "key": "token",
              "value": "{{token}}",
              "type": "string"
            }
          ]
        },
        "method": "PUT",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"phone\": \"123456\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/user/profile",
          "host": ["{{baseUrl}}"],
          "path": ["user", "profile"]
        },
        "description": "使用无效格式的手机号测试验证"
      },
      "response": []
    },
    {
      "name": "无授权获取资料测试",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"状态码为401\", () => {",
              "    pm.response.to.have.status(401);",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/user/profile",
          "host": ["{{baseUrl}}"],
          "path": ["user", "profile"]
        },
        "description": "无认证头测试"
      },
      "response": []
    }
  ]
}
```

## 6. 测试报告模板

### 6.1 测试概要
| 测试类型 | 执行数量 | 通过数量 | 失败数量 | 通过率 |
| ------ | ------ | ------ | ------ | ------ |
| 单元测试 | | | | |
| API测试 | | | | |
| 安全测试 | | | | |
| 总计 | | | | |

### 6.2 测试详情
| 测试ID | 测试描述 | 预期结果 | 实际结果 | 状态 | 备注 |
| ------ | ------ | ------ | ------ | ------ | ------ |
| UT-001 | 获取存在用户的资料 | 返回用户资料 | | | |
| UT-002 | 获取不存在用户的资料 | 抛出异常 | | | |
| API-001 | 正常获取个人资料 | 状态码200 | | | |
| API-002 | 无token获取资料 | 状态码401 | | | |
| ... | ... | ... | ... | ... | ... |

### 6.3 问题记录
| 问题ID | 问题描述 | 严重程度 | 状态 | 修复建议 |
| ------ | ------ | ------ | ------ | ------ |
| | | | | |

### 6.4 测试结论
(填写测试结论和建议)

## 7. 测试执行计划

### 7.1 测试时间表
| 阶段 | 开始日期 | 结束日期 | 负责人 |
| ------ | ------ | ------ | ------ |
| 单元测试 | | | |
| API测试 | | | |
| 测试报告 | | | |

### 7.2 测试优先级
1. 高优先级：身份验证、防越权测试
2. 中优先级：基本功能测试
3. 低优先级：边界情况和异常测试 